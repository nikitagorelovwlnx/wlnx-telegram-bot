# Тесты для WLNX Telegram Bot

Этот каталог содержит комплексные тесты для Telegram бота с мокированием внешних сервисов.

## Структура тестов

### `setup.ts`
Настройка тестовой среды:
- Мокирование OpenAI API
- Мокирование Axios для API вызовов
- Мокирование Telegraf
- Настройка переменных окружения

### `services/`
**conversationService.test.ts**
- Тесты генерации ответов AI
- Тесты извлечения данных пользователей
- Тесты генерации wellness summary
- Обработка ошибок OpenAI

**apiService.test.ts**
- Тесты CRUD операций для wellness интервью
- Тесты аутентификации пользователей
- Тесты обработки ошибок API
- Мокирование axios запросов

### `handlers/`
**commandHandler.test.ts**
- Тесты команд бота (/start, /help, etc.)
- Тесты естественного диалога
- Тесты регистрации пользователей
- Тесты сохранения интервью

### `data-extraction/`
**userInfoExtraction.test.ts**
- Детальные тесты извлечения демографических данных
- Тесты биометрических показателей
- Тесты медицинской информации
- Тесты целей и предпочтений
- Тесты дедупликации данных

### `integration/`
**bot-workflow.test.ts**
- Полный цикл: регистрация → диалог → извлечение → сохранение
- Тесты автосохранения
- Тесты консистентности данных
- Тесты производительности
- Тесты приватности данных

## Запуск тестов

```bash
# Все тесты
npm test

# Конкретный тест
npm test -- conversationService.test.ts

# С покрытием кода
npm run test:coverage

# Режим наблюдения
npm run test:watch
```

## Настройка мокирования

### OpenAI API
Мокируется в `setup.ts`, возвращает предсказуемые ответы для тестирования.

### Axios/API вызовы
Каждый тест настраивает свои мок-ответы через `mockAxiosInstance`.

### Telegram Bot API
Мокируется Telegraf и Context для симуляции взаимодействий.

## Паттерны тестирования

### 1. Изоляция тестов
Каждый тест независим и очищает состояние в `beforeEach`.

### 2. Мокирование внешних зависимостей
- OpenAI API
- HTTP запросы
- Telegram API
- Логирование

### 3. Тестирование edge cases
- Пустые/некорректные данные
- API ошибки
- Сетевые проблемы
- Большие объемы данных

### 4. Интеграционные тесты
Тестируют полные пользовательские сценарии end-to-end.

## Метрики покрытия

Целевые показатели:
- **Statements**: > 80%
- **Branches**: > 75%
- **Functions**: > 85%
- **Lines**: > 80%

## Отладка тестов

```bash
# Запуск с детальным выводом
npm test -- --verbose

# Отладка конкретного теста
npm test -- --testNamePattern="should extract age"

# Только неудачные тесты
npm test -- --onlyFailures
```

## Continuous Integration

Тесты автоматически запускаются при:
- Push в любую ветку
- Pull Request
- Scheduled builds

## Добавление новых тестов

1. Создать файл в соответствующей папке
2. Импортировать необходимые зависимости
3. Настроить мокирование в `beforeEach`
4. Написать тесты следуя существующим паттернам
5. Обеспечить очистку состояния после тестов
